# AS400 COBOL Build and Deployment Guide

## Prerequisites
- AS400/IBM i system access
- COBOL compiler (ILE COBOL)
- Source physical files (QCBLLESRC)
- Appropriate library permissions

## Basic Compilation Commands

### Individual Program Compilation
```bash
# Create COBOL module
CRTCBLMOD MODULE(MYLIB/HERON) SRCFILE(MYLIB/QCBLLESRC) SRCMBR(HERON)

# Create program object
CRTPGM PGM(MYLIB/HERON) MODULE(MYLIB/HERON)
```

### Batch Compilation
```bash
# Compile all programs in the CallingExample project
CRTCBLMOD MODULE(MYLIB/CALLER) SRCFILE(MYLIB/QCBLLESRC) SRCMBR(CALLER)
CRTCBLMOD MODULE(MYLIB/CALLER2) SRCFILE(MYLIB/QCBLLESRC) SRCMBR(CALLER2)
CRTCBLMOD MODULE(MYLIB/HERON) SRCFILE(MYLIB/QCBLLESRC) SRCMBR(HERON)
CRTCBLMOD MODULE(MYLIB/NESTEDCALL) SRCFILE(MYLIB/QCBLLESRC) SRCMBR(NESTEDCALL)

CRTPGM PGM(MYLIB/CALLER) MODULE(MYLIB/CALLER)
CRTPGM PGM(MYLIB/CALLER2) MODULE(MYLIB/CALLER2)
CRTPGM PGM(MYLIB/HERON) MODULE(MYLIB/HERON)
CRTPGM PGM(MYLIB/NESTEDCALL) MODULE(MYLIB/NESTEDCALL)
```

### Compilation with Debug Information
```bash
# Compile with debug and event file
CRTCBLMOD MODULE(MYLIB/HERON) SRCFILE(MYLIB/QCBLLESRC) SRCMBR(HERON) 
          OPTION(*EVENTF) DBGVIEW(*SOURCE)

# Create program with debug info
CRTPGM PGM(MYLIB/HERON) MODULE(MYLIB/HERON) 
       OPTION(*DUPPROC) ALWUPD(*YES)
```

### Compilation with Optimization
```bash
# Optimize for performance
CRTCBLMOD MODULE(MYLIB/HERON) SRCFILE(MYLIB/QCBLLESRC) SRCMBR(HERON) 
          OPTIMIZE(40) OPTION(*EVENTF)
```

## CL Program for Automated Build

```cobol
PGM
DCL VAR(&LIBRARY) TYPE(*CHAR) LEN(10) VALUE('COBOLDEM')
DCL VAR(&SRCFILE) TYPE(*CHAR) LEN(10) VALUE('QCBLLESRC')

/* Create library if it doesn't exist */
MONMSG MSGID(CPF2111) EXEC(CRTLIB LIB(&LIBRARY))

/* Compile HERON first (it's called by others) */
CRTCBLMOD MODULE(&LIBRARY/HERON) SRCFILE(&LIBRARY/&SRCFILE) SRCMBR(HERON)
CRTPGM PGM(&LIBRARY/HERON) MODULE(&LIBRARY/HERON)

/* Compile calling programs */
CRTCBLMOD MODULE(&LIBRARY/CALLER) SRCFILE(&LIBRARY/&SRCFILE) SRCMBR(CALLER)
CRTPGM PGM(&LIBRARY/CALLER) MODULE(&LIBRARY/CALLER)

CRTCBLMOD MODULE(&LIBRARY/CALLER2) SRCFILE(&LIBRARY/&SRCFILE) SRCMBR(CALLER2)
CRTPGM PGM(&LIBRARY/CALLER2) MODULE(&LIBRARY/CALLER2)

CRTCBLMOD MODULE(&LIBRARY/NESTEDCALL) SRCFILE(&LIBRARY/&SRCFILE) SRCMBR(NESTEDCALL)
CRTPGM PGM(&LIBRARY/NESTEDCALL) MODULE(&LIBRARY/NESTEDCALL)

SNDPGMMSG MSG('Build completed for CallingExample project')

ENDPGM
```

## JCL Template for z/OS

```jcl
//COBOLCMP JOB CLASS=A,MSGCLASS=X,NOTIFY=&SYSUID,TIME=10
//*
//* COBOL Compilation JCL for CallingExample Programs
//*
//STEP1    EXEC PGM=IGYCRCTL,PARM='LIB,APOST,NODYNAM'
//STEPLIB  DD  DSN=SYS1.COBOL.COMPILER,DISP=SHR
//SYSLIB   DD  DSN=SYS1.COBOL.COPYLIB,DISP=SHR
//         DD  DSN=YOUR.COPYBOOK.LIBRARY,DISP=SHR
//SYSIN    DD  DSN=YOUR.SOURCE.LIBRARY(HERON),DISP=SHR
//SYSPRINT DD  SYSOUT=*
//SYSOUT   DD  SYSOUT=*
//SYSOBJ   DD  DSN=YOUR.OBJECT.LIBRARY(HERON),DISP=(NEW,CATLG,DELETE),
//             UNIT=SYSDA,SPACE=(CYL,(1,1)),
//             DCB=(RECFM=FB,LRECL=80,BLKSIZE=800)
//*
//STEP2    EXEC PGM=IGYCRCTL,PARM='LIB,APOST,NODYNAM'
//STEPLIB  DD  DSN=SYS1.COBOL.COMPILER,DISP=SHR
//SYSLIB   DD  DSN=SYS1.COBOL.COPYLIB,DISP=SHR
//         DD  DSN=YOUR.COPYBOOK.LIBRARY,DISP=SHR
//SYSIN    DD  DSN=YOUR.SOURCE.LIBRARY(CALLER),DISP=SHR
//SYSPRINT DD  SYSOUT=*
//SYSOUT   DD  SYSOUT=*
//SYSOBJ   DD  DSN=YOUR.OBJECT.LIBRARY(CALLER),DISP=(NEW,CATLG,DELETE),
//             UNIT=SYSDA,SPACE=(CYL,(1,1)),
//             DCB=(RECFM=FB,LRECL=80,BLKSIZE=800)
```

## Makefile for Modern Development

```makefile
# Makefile for AS400 COBOL CallingExample
LIBRARY = COBOLDEM
SRCFILE = QCBLLESRC

# Program dependencies
PROGRAMS = CALLER CALLER2 HERON NESTEDCALL
MODULES = $(addprefix $(LIBRARY)/, $(PROGRAMS))

.PHONY: all clean compile test

all: compile

compile: $(PROGRAMS)

HERON:
	CRTCBLMOD MODULE($(LIBRARY)/HERON) SRCFILE($(LIBRARY)/$(SRCFILE)) SRCMBR(HERON)
	CRTPGM PGM($(LIBRARY)/HERON) MODULE($(LIBRARY)/HERON)

CALLER: HERON
	CRTCBLMOD MODULE($(LIBRARY)/CALLER) SRCFILE($(LIBRARY)/$(SRCFILE)) SRCMBR(CALLER)
	CRTPGM PGM($(LIBRARY)/CALLER) MODULE($(LIBRARY)/CALLER)

CALLER2: HERON
	CRTCBLMOD MODULE($(LIBRARY)/CALLER2) SRCFILE($(LIBRARY)/$(SRCFILE)) SRCMBR(CALLER2)
	CRTPGM PGM($(LIBRARY)/CALLER2) MODULE($(LIBRARY)/CALLER2)

NESTEDCALL:
	CRTCBLMOD MODULE($(LIBRARY)/NESTEDCALL) SRCFILE($(LIBRARY)/$(SRCFILE)) SRCMBR(NESTEDCALL)
	CRTPGM PGM($(LIBRARY)/NESTEDCALL) MODULE($(LIBRARY)/NESTEDCALL)

clean:
	DLTPGM PGM($(LIBRARY)/CALLER)
	DLTPGM PGM($(LIBRARY)/CALLER2)
	DLTPGM PGM($(LIBRARY)/HERON)
	DLTPGM PGM($(LIBRARY)/NESTEDCALL)
	DLTMOD MODULE($(LIBRARY)/CALLER)
	DLTMOD MODULE($(LIBRARY)/CALLER2)
	DLTMOD MODULE($(LIBRARY)/HERON)
	DLTMOD MODULE($(LIBRARY)/NESTEDCALL)

test:
	CALL PGM($(LIBRARY)/CALLER)
	CALL PGM($(LIBRARY)/CALLER2)
	CALL PGM($(LIBRARY)/NESTEDCALL)
```

## Deployment Script

```bash
#!/bin/bash
# deploy.sh - Deploy COBOL programs to AS400

LIBRARY="COBOLDEM"
AS400_USER="youruser"
AS400_HOST="your.as400.system"

echo "Deploying CallingExample to AS400..."

# Upload source files
ftp -n $AS400_HOST << EOF
user $AS400_USER
binary
put CALLER.CBLLE "CALLER"
put CALLER2.CBLLE "CALLER2"
put HERON.CBLLE "HERON"
put NESTEDCALL.CBLLE "NESTEDCALL"
quit
EOF

# Remote compilation
ssh $AS400_USER@$AS400_HOST << EOF
CRTCBLMOD MODULE($LIBRARY/HERON) SRCFILE($LIBRARY/QCBLLESRC) SRCMBR(HERON)
CRTPGM PGM($LIBRARY/HERON) MODULE($LIBRARY/HERON)

CRTCBLMOD MODULE($LIBRARY/CALLER) SRCFILE($LIBRARY/QCBLLESRC) SRCMBR(CALLER)
CRTPGM PGM($LIBRARY/CALLER) MODULE($LIBRARY/CALLER)

CRTCBLMOD MODULE($LIBRARY/CALLER2) SRCFILE($LIBRARY/QCBLLESRC) SRCMBR(CALLER2)
CRTPGM PGM($LIBRARY/CALLER2) MODULE($LIBRARY/CALLER2)

CRTCBLMOD MODULE($LIBRARY/NESTEDCALL) SRCFILE($LIBRARY/QCBLLESRC) SRCMBR(NESTEDCALL)
CRTPGM PGM($LIBRARY/NESTEDCALL) MODULE($LIBRARY/NESTEDCALL)
EOF

echo "Deployment completed!"
```

## Common Compilation Errors and Solutions

### Error: Program not found
```
Solution: Ensure the called program (HERON) is compiled first
Command: CRTCBLMOD MODULE(MYLIB/HERON) SRCFILE(MYLIB/QCBLLESRC) SRCMBR(HERON)
         CRTPGM PGM(MYLIB/HERON) MODULE(MYLIB/HERON)
```

### Error: Undefined variable
```
Solution: Fix variable references in source code
- CALLER.CBLLE line 15: Change PLOCHA-DISPLAYED to AREA-DISP
- NESTEDCALL.CBLLE line 13-14: Change PLOCHA to AREA
```

### Error: Source member not found
```
Solution: Ensure source files are properly uploaded to QCBLLESRC
Command: CPYFRMSTMF FROMSTMF('/path/to/HERON.CBLLE') 
                    TOMBR('/QSYS.LIB/MYLIB.LIB/QCBLLESRC.FILE/HERON.MBR')
```

## Performance Optimization Tips

1. **Use PACKED-DECIMAL for calculations**
   - Already implemented in CallingExample
   - Optimal for AS400 processors

2. **Minimize parameter passing**
   - Group related parameters
   - Use BY REFERENCE when possible

3. **Optimize CALL statements**
   - Use static calls for better performance
   - Consider service programs for frequently called routines

4. **Compiler optimization**
   - Use OPTIMIZE(40) for production builds
   - Enable optimization for mathematical operations