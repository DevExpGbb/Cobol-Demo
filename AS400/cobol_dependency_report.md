# COBOL Dependency Analysis Report

**Analysis Date:** Generated by COBOL Dependency Subagent  
**Scope:** AS400/QCBLLESRC and AS400/COBOL_examples directories

---

## Executive Summary

This report analyzes the dependency structure of 27 COBOL programs across multiple directories. The analysis identifies data flow dependencies, copybook usage patterns, program call relationships, and potential areas for improvement in modularity and maintainability.

---

## 1. Directory Structure Analysis

### 1.1 Primary Source Directory: `/AS400/QCBLLESRC/`
- **Total Programs:** 9
- **Program Types:** Production batch processing, screen handling, demo programs
- **Key Programs:**
  - STAOBR.CBLLE - State/stock update from transactions
  - STAOBR2.CBLLE - Variant state update processing
  - STAOBR_2.CBLLE - Advanced state update with reversed logic
  - STAPOR.CBLLE - Interactive screen-based state inquiry/update
  - staobr0cp.cblle - Modern version with logging integration
  - DUMP_FULL.CBLLE - Dump utility copybook
  - COND1.CBLLE - Conditional logic demonstration
  - TABULKY1.CBLLE - Single-dimension array handling
  - TABULKY2.CBLLE - Multi-dimensional array handling

### 1.2 Example Programs Directory: `/AS400/COBOL_examples/`
Organized into functional subdirectories:
- **CallingExample/** - Program calling patterns (4 programs)
- **Holidays/** - Date calculation utilities (2 programs)
- **Logging/** - Logging service module (1 program)
- **MoveClause/** - Data movement examples (4 programs)
- **PictureClause/** - Data type demonstrations (4 programs)

---

## 2. Copybook Dependencies

### 2.1 DDS (Data Description Specifications) Copybooks

#### High Dependency Programs
| Program | Copybook Usage | Purpose |
|---------|---------------|---------|
| STAOBR.CBLLE | DDS-ALL-FORMATS OF STAVY, DDS-ALL-FORMATS OF OBRATY | File structure imports |
| STAOBR2.CBLLE | DDS-ALL-FORMATS OF STAVY, DDS-ALL-FORMATS OF OBRATY | File structure imports |
| STAOBR_2.CBLLE | DDS-ALL-FORMATS OF STAVY, DDS-ALL-FORMATS OF OBRATY | File structure imports |
| STAPOR.CBLLE | DDS-ALL-FORMATS OF STAVYW, DDS-STAVYF0 OF STAVY | Screen and file formats |
| staobr0cp.cblle | DDS-ALL-FORMATS OF STAVYP0, DDS-ALL-FORMATS OF OBRATYP0 | File structure imports |
| LOG0010CB.cblle | DDS-ALL-FORMATS OF LOGP0 | Log file structure |

**Analysis:** The DDS copybooks create an external dependency on database file definitions. All state management programs (STAOBR variants) depend on STAVY and OBRATY file structures. This is a strong coupling point.

### 2.2 Working Storage Copybooks

#### DUMP_FULL Copybook
- **Referenced by:** COND1.CBLLE (commented out), PICTURE1-4.CBLLE (active)
- **Purpose:** Provides standard error handling and dump variables
- **Contents:** ERROR-CODE structure, PROGRAM-TYPE, DUMP-TYPE definitions
- **Dependency Type:** Optional utility copybook

**Pattern:** DUMP_FULL is used for debugging/diagnostic purposes via QlnDumpCobol API calls.

---

## 3. Program Call Dependencies

### 3.1 Direct Program Calls

#### Call Graph
```
CALLER.CBLLE ──────────► HERON (external)
CALLER2.CBLLE ─────────► HERON (external)
NESTEDCALL.CBLLE ──────► HERON (nested/internal)
staobr0cp.cblle ───────► LOG0010CB (external service)
LOG0010CB.cblle ───────► getjoba1cl (CL program - external)
```

### 3.2 Call Dependency Analysis

#### Type 1: Mathematical Service Calls
- **Caller Programs:** CALLER.CBLLE, CALLER2.CBLLE
- **Called Program:** HERON
- **Coupling Level:** Loose - Interface-based via parameters
- **Data Flow:** Input (A, B, C sides) → Output (AREA calculation)
- **Modularity:** ✓ Good - Clear separation of concerns

#### Type 2: Logging Service Calls
- **Caller Programs:** staobr0cp.cblle
- **Called Program:** LOG0010CB
- **Coupling Level:** Loose - Message passing only
- **Data Flow:** One-way (caller → logger)
- **Modularity:** ✓ Excellent - Centralized logging service

#### Type 3: System API Calls
- **Caller Programs:** PICTURE1-4.CBLLE
- **Called Program:** QlnDumpCobol (IBM i system procedure)
- **Coupling Level:** Tight - System dependency
- **Purpose:** Memory dump for debugging

#### Type 4: Nested Program Structure
- **Program:** NESTEDCALL.CBLLE
- **Pattern:** Contains HERON as nested subprogram
- **Modularity:** ⚠ Potential issue - Creates tight coupling within single source file
- **Recommendation:** Consider extracting to separate module for reusability

### 3.3 Cross-Language Dependencies
- **LOG0010CB → getjoba1cl:** COBOL calling CL (Control Language)
- **Purpose:** Job attribute retrieval (job name, user, job number)
- **Pattern:** Common AS400/IBM i pattern for system information access

---

## 4. File I/O Dependencies

### 4.1 Database Files

#### STAVY (State/Stock File)
- **Access Type:** Indexed, Dynamic/Random access
- **Key:** Externally-described composite key (ZAVOD, SKLAD, MATER)
- **Dependent Programs:** 
  - STAOBR.CBLLE (I-O, UPDATE mode)
  - STAOBR2.CBLLE (I-O, UPDATE mode)
  - STAOBR_2.CBLLE (I-O, UPDATE mode)
  - STAPOR.CBLLE (I-O, INTERACTIVE mode)
  - staobr0cp.cblle (I-O, UPDATE mode)

#### OBRATY (Transaction File)
- **Access Type:** Sequential
- **Dependent Programs:**
  - STAOBR.CBLLE (INPUT, READ-ONLY)
  - STAOBR2.CBLLE (INPUT, READ-ONLY)
  - STAOBR_2.CBLLE (INPUT with key positioning)
  - staobr0cp.cblle (INPUT, READ-ONLY)

**Data Flow Pattern:**
```
OBRATY (Transactions) ──READ──► Program Logic ──UPDATE──► STAVY (States)
```

#### LOGP0 (Log File)
- **Access Type:** Sequential, EXTEND mode
- **Dependent Program:** LOG0010CB.cblle
- **Purpose:** Application activity audit trail

### 4.2 Screen Files (Workstation)

#### STAVYW (State Workstation File)
- **Access Type:** Transaction (interactive)
- **Dependent Program:** STAPOR.CBLLE
- **Purpose:** Screen I/O for interactive state management
- **Formats:** STAVYW1 (input), STAVYW2 (detail)

---

## 5. Data Flow Dependency Analysis

### 5.1 State Update Processing Chain

```
┌─────────────┐
│   OBRATY    │  (Source: Transaction data)
│   File      │
└──────┬──────┘
       │ READ
       ▼
┌─────────────────────────────────────────┐
│  Processing Programs (Multiple variants)│
│  - STAOBR.CBLLE                        │
│  - STAOBR2.CBLLE                       │
│  - STAOBR_2.CBLLE                      │
│  - staobr0cp.cblle                     │
└──────┬──────────────────────────────────┘
       │ UPDATE (MNOZ field)
       ▼
┌─────────────┐
│   STAVY     │  (Target: Current state/stock)
│   File      │
└─────────────┘
```

### 5.2 Key Data Elements

#### Composite Key Structure (Shared across STAVY/OBRATY)
- **ZAVOD** - Plant/Factory ID
- **SKLAD** - Warehouse ID  
- **MATER** - Material ID

#### Transaction Data
- **MNOBR** (in OBRATY) - Transaction quantity
- **MNOZ** (in STAVY) - Current quantity state

**Critical Dependency:** All state update programs depend on this key structure matching between OBRATY and STAVY files.

---

## 6. Circular Dependency Analysis

### 6.1 File-Level Dependencies
**Result:** ✓ **No circular dependencies detected**

The data flow is unidirectional:
- OBRATY → Processing Logic → STAVY
- No programs write back to OBRATY
- No programs read from files they write to in the same operation

### 6.2 Program-Level Dependencies

**Result:** ✓ **No circular dependencies detected**

Analysis of program calls:
- CALLER/CALLER2 → HERON (one-way)
- staobr0cp → LOG0010CB → getjoba1cl (linear chain)
- No programs call back to their callers

### 6.3 Copybook Dependencies

**Result:** ✓ **No circular dependencies detected**

- DDS copybooks are imported only (no mutual references)
- DUMP_FULL is standalone utility copybook
- No copybook includes other copybooks

---

## 7. Modularity Assessment

### 7.1 Well-Modularized Components ✓

#### Logging Service (LOG0010CB)
- **Strengths:**
  - Single responsibility (logging only)
  - Reusable across applications
  - Clean interface (single message parameter)
  - Centralized audit trail
- **Usage Pattern:** Service-oriented architecture
- **Rating:** Excellent modularity

#### Mathematical Services (HERON)
- **Strengths:**
  - Pure calculation logic
  - No side effects
  - Reusable utility
  - Clear input/output contract
- **Rating:** Excellent modularity

### 7.2 Moderately Modular Components ⚠

#### State Update Programs (STAOBR variants)
- **Strengths:**
  - Each handles specific use case
  - Separation of concerns between variants
- **Concerns:**
  - Code duplication across 4 similar programs
  - Same logic implemented differently
  - Similar file dependencies repeated
- **Improvement Opportunity:**
  - Extract common logic to shared subprogram
  - Use parameter-driven approach instead of code duplication
- **Rating:** Moderate modularity

### 7.3 Tightly Coupled Components ⚠

#### STAPOR.CBLLE (Interactive State Management)
- **Concerns:**
  - Combines UI logic with business logic
  - Screen handling and database operations mixed
  - Complex flow control with GO TO statements
  - Hard to test business logic independently
- **Improvement Opportunity:**
  - Separate presentation layer from business logic
  - Extract database operations to service layer
  - Reduce GO TO usage in favor of structured programming
- **Rating:** Low modularity

### 7.4 Legacy Pattern Analysis

#### GO TO Usage
**Programs with GO TO:** STAPOR.CBLLE, STAOBR_2.CBLLE
- **Impact:** Reduces readability and testability
- **Modern Alternative:** PERFORM ... UNTIL, structured sections
- **Recommendation:** Refactor to eliminate GO TO statements

#### MOVE CORRESPONDING Pattern
**Programs using CORR:** STAOBR2.CBLLE, STAOBR_2.CBLLE, STAPOR.CBLLE
- **Benefit:** Reduces verbose field-by-field moves
- **Risk:** Implicit dependencies on field naming conventions
- **Recommendation:** Document field naming standards

---

## 8. Dependency Metrics

### 8.1 Coupling Metrics

| Program | File Dependencies | Copybook Dependencies | Program Call Dependencies | Total Coupling Score |
|---------|-------------------|----------------------|---------------------------|---------------------|
| staobr0cp.cblle | 2 | 2 | 1 | 5 (Medium) |
| STAPOR.CBLLE | 2 | 2 | 0 | 4 (Medium) |
| STAOBR.CBLLE | 2 | 2 | 0 | 4 (Medium) |
| STAOBR2.CBLLE | 2 | 2 | 0 | 4 (Medium) |
| STAOBR_2.CBLLE | 2 | 2 | 0 | 4 (Medium) |
| LOG0010CB.cblle | 1 | 1 | 1 | 3 (Low) |
| CALLER.CBLLE | 0 | 0 | 1 | 1 (Low) |
| HERON.CBLLE | 0 | 0 | 0 | 0 (None) |
| CANDAY01.CBLLE | 0 | 0 | 0 | 0 (None) |

### 8.2 Reusability Assessment

| Component | Reusability | Reason |
|-----------|-------------|--------|
| LOG0010CB | High | Generic logging service, parameter-driven |
| HERON | High | Pure function, no external dependencies |
| DUMP_FULL copybook | High | Standard utility copybook |
| CANDAY01 | Medium | Self-contained but specific use case |
| STAOBR variants | Low | Tightly coupled to specific database schema |
| STAPOR | Low | UI-specific, tightly coupled to screens |

---

## 9. Potential Issues and Risks

### 9.1 Code Duplication Risk ⚠ HIGH

**Issue:** Four variants of state update logic (STAOBR, STAOBR2, STAOBR_2, staobr0cp)

**Impact:**
- Maintenance burden - bugs must be fixed in multiple places
- Inconsistent behavior across variants
- Testing overhead

**Evidence:**
- All four programs perform similar OBRATY → STAVY updates
- Key mapping logic duplicated
- File handling patterns repeated

**Recommendation:**
```
Priority: HIGH
Action: Consolidate into single parameterized program
Approach: 
  1. Extract common logic to STAOBR-COMMON subprogram
  2. Pass processing mode as parameter
  3. Retire duplicate variants
Estimated Effort: 2-3 weeks
```

### 9.2 Schema Change Vulnerability ⚠ MEDIUM

**Issue:** Tight coupling to DDS-defined file structures

**Impact:**
- Database schema changes require recompilation of all dependent programs
- Risk of runtime failures if copybooks don't match database

**Affected Programs:** All programs using DDS-ALL-FORMATS

**Recommendation:**
```
Priority: MEDIUM
Action: Implement abstraction layer
Approach:
  1. Create data access subprograms
  2. Isolate schema knowledge to access layer
  3. Use working storage structures in business logic
Estimated Effort: 4-6 weeks
```

### 9.3 Lack of Error Handling ⚠ MEDIUM

**Issue:** Inconsistent error handling across programs

**Evidence:**
- STAOBR.CBLLE - Minimal error handling
- staobr0cp.cblle - Good file status checking
- No standardized error handling pattern

**Recommendation:**
```
Priority: MEDIUM
Action: Implement standard error handling framework
Approach:
  1. Create ERROR-HANDLER copybook
  2. Define standard error codes
  3. Implement in all programs
Estimated Effort: 2 weeks
```

### 9.4 Testing Challenges ⚠ MEDIUM

**Issue:** Programs tightly coupled to physical files make unit testing difficult

**Impact:**
- Requires database setup for testing
- Cannot test business logic in isolation
- Integration testing only

**Recommendation:**
```
Priority: MEDIUM
Action: Refactor for testability
Approach:
  1. Separate business logic from I/O
  2. Create mockable interfaces for file access
  3. Implement service layer pattern
Estimated Effort: 6-8 weeks
```

---

## 10. Legacy Patterns Affecting Dependencies

### 10.1 Monolithic Program Structure
**Pattern:** Single program handles multiple responsibilities
**Example:** STAPOR.CBLLE (UI + validation + database + business logic)
**Modern Alternative:** Layered architecture with separation of concerns

### 10.2 Implicit Dependencies via COPY DDS
**Pattern:** Programs inherit full file structures from DDS
**Issue:** Creates hidden dependencies on all fields, not just used fields
**Modern Alternative:** Define explicit working storage structures with only needed fields

### 10.3 External File Declarations
**Pattern:** FILE-CONTROL section defines physical file dependencies
**Issue:** Hard-coded file names create deployment inflexibility
**Modern Alternative:** Environment-based configuration, externalized file mappings

### 10.4 GO TO Flow Control
**Pattern:** Non-structured jumps between sections
**Example:** STAPOR.CBLLE uses GO TO extensively
**Issue:** Makes dependency tracing difficult, reduces maintainability
**Modern Alternative:** PERFORM-based structured programming

---

## 11. Recommendations Summary

### 11.1 Immediate Actions (0-3 months)

1. **Standardize Error Handling**
   - Create ERROR-HANDLER copybook
   - Implement in all programs
   - Priority: HIGH

2. **Document Dependencies**
   - Create dependency diagrams for each subsystem
   - Document file structure requirements
   - Priority: HIGH

3. **Code Consolidation**
   - Merge STAOBR variants into single parameterized program
   - Eliminate code duplication
   - Priority: HIGH

### 11.2 Medium-Term Actions (3-6 months)

4. **Implement Service Layer**
   - Extract file I/O to data access services
   - Create reusable business logic components
   - Priority: MEDIUM

5. **Refactor STAPOR**
   - Separate UI from business logic
   - Eliminate GO TO statements
   - Priority: MEDIUM

6. **Enhance Logging**
   - Extend LOG0010CB usage to all production programs
   - Add structured logging with severity levels
   - Priority: MEDIUM

### 11.3 Long-Term Strategic Actions (6-12 months)

7. **Modernize Architecture**
   - Implement layered architecture (Presentation, Business, Data)
   - Create abstraction layer for database access
   - Priority: LOW

8. **Improve Testability**
   - Refactor for unit testing capability
   - Implement test data management
   - Priority: LOW

9. **Create Reusable Component Library**
   - Extract common utilities
   - Build shared service catalog
   - Priority: LOW

---

## 12. Dependency Best Practices

### 12.1 Current Good Practices ✓

1. **Logging Service Pattern** (LOG0010CB)
   - Centralized, reusable service
   - Clean interface
   - Single responsibility

2. **DDS Copybook Usage**
   - Ensures consistency with database schema
   - Reduces manual structure definition errors

3. **File Status Checking** (staobr0cp.cblle)
   - Proper error detection
   - Logging of errors

### 12.2 Recommended Practices for New Development

1. **Minimize File Dependencies**
   - Access files through service layer
   - Use working storage for business logic

2. **Prefer Loose Coupling**
   - Use parameter passing over shared data
   - Avoid global variables

3. **Document Dependencies**
   - Comment COPY statements with purpose
   - Document CALL interfaces

4. **Version Control Integration**
   - Track copybook changes
   - Maintain dependency manifests

---

## 13. Conclusion

### Overall Assessment

The COBOL codebase demonstrates a **moderate level of modularity** with clear opportunities for improvement:

**Strengths:**
- Good separation in utility services (LOG0010CB, HERON)
- No circular dependencies
- Consistent use of copybooks for file structures
- Modern logging integration in newer programs

**Areas for Improvement:**
- Code duplication across STAOBR variants
- Tight coupling to physical file structures
- Mixed concerns in interactive programs
- Legacy flow control patterns (GO TO)
- Inconsistent error handling

**Risk Level:** MEDIUM
- No critical architectural flaws
- Maintainable with focused refactoring effort
- Manageable technical debt

### Dependency Health Score: 6.5/10

**Breakdown:**
- Copybook Management: 7/10
- Program Coupling: 6/10
- Modularity: 6/10
- Reusability: 7/10
- Testability: 5/10
- Error Handling: 6/10

### Final Recommendation

Focus on the **high-priority code consolidation** and **error handling standardization** initiatives. These will provide the most immediate value in reducing maintenance burden and improving reliability. The longer-term architectural improvements can be phased in as resources permit.

---

**Report Generated By:** COBOL Dependency Analysis Subagent  
**Analysis Coverage:** 27 COBOL programs, 6 copybook references, 4 program call chains  
**Next Review Recommended:** After implementation of high-priority recommendations
